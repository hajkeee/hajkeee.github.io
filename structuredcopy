<script>
  window.addEventListener('DOMContentLoaded', function () {
    const event = window.dataLayer.find(e => e.event === 'Purchase');
    if (event) {
      const clone = structuredClone(event);
      sessionStorage.setItem('purchaseData', JSON.stringify(clone));
    }
  });
</script>

v2
<script>
  window.addEventListener('DOMContentLoaded', function () {
    var purchase;
    for (var i = 0; i < dataLayer.length; i++) {
      if (dataLayer[i].event === 'purchase') {
        purchase = dataLayer[i];
        break;
      }
    }

    if (purchase) {
      try {
        var cloned = JSON.parse(JSON.stringify(purchase));
        sessionStorage.setItem('purchaseData', JSON.stringify(cloned));
      } catch (e) {
        console.error('Error saving purchase:', e);
      }
    }
  });
</script>

v3

<script>
(function () {
  window.dataLayer = window.dataLayer || [];

  // Беремо існуючий метод push
  var originalPush = window.dataLayer.push;

  // Перехоплюємо всі нові події
  window.dataLayer.push = function () {
    // Проходимося по всіх переданих аргументах
    for (var i = 0; i < arguments.length; i++) {
      var item = arguments[i];
      if (item && item.event === 'Purchase') {
        try {
          var clone = JSON.parse(JSON.stringify(item));
          sessionStorage.setItem('purchaseData', JSON.stringify(clone));
          sessionStorage.removeItem('purchaseTransferred'); // обнуляємо на випадок
          console.log('[GTM] ✅ Збережено подію purchase через push:', clone);
        } catch (e) {
          console.error('[GTM] ❌ Помилка при клонуванні purchase:', e);
        }
      }
    }

    // Викликаємо оригінальний push
    return originalPush.apply(window.dataLayer, arguments);
  };
})();
</script>








Restore Purchase Event from SessionStorage

<script>
  window.addEventListener('DOMContentLoaded', function () {
    if (!sessionStorage.getItem('purchaseData') || sessionStorage.getItem('purchaseTransferred')) {
      return;
    }

    try {
      const purchase = JSON.parse(sessionStorage.getItem('purchaseData'));
      if (purchase) {
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push(purchase);
        sessionStorage.setItem('purchaseTransferred', 'true'); 
      }
    } catch (e) {
      console.error('Failed to restore purchase', e);
    }
  });
</script>

v2
<script>
  window.addEventListener('DOMContentLoaded', function () {
    if (sessionStorage.getItem('purchaseTransferred')) return;

    try {
      var stored = sessionStorage.getItem('purchaseData');
      if (stored) {
        var purchase = JSON.parse(stored);
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push(purchase);
        sessionStorage.setItem('purchaseTransferred', 'true');
      }
    } catch (e) {
      console.error('Error restoring purchase:', e);
    }
  });
</script>



v3

<script>
  window.addEventListener('DOMContentLoaded', function () {
    try {
      if (sessionStorage.getItem('purchaseTransferred')) {
        console.log('[GTM] ⏭ Уже пушили purchase');
        return;
      }

      var raw = sessionStorage.getItem('purchaseData');
      if (!raw) {
        console.warn('[GTM] ⚠️ Немає збереженої purchase події');
        return;
      }

      var purchase = JSON.parse(raw);
      if (purchase && purchase.event === 'purchase') {
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push(purchase);
        sessionStorage.setItem('purchaseTransferred', 'true');
        console.log('[GTM] ✅ Відновлено purchase:', purchase);
      } else {
        console.warn('[GTM] ⚠️ Неправильна структура події');
      }
    } catch (e) {
      console.error('[GTM] ❌ Помилка відновлення:', e);
    }
  });
</script>

