(function() {
  var appSwitchTimer = null;
  var timeoutDuration = 500; 

  function pushToDataLayer(eventName, params) {
    window.dataLayer = window.dataLayer || [];
    var eventData = {
      event: eventName,
      timestamp: new Date().toISOString()
    };
    for (var key in params) {
      if (params.hasOwnProperty(key)) {
        eventData[key] = params[key];
      }
    }
    dataLayer.push(eventData);
    console.log('GTM Event Fired: ' + eventName, params); // ES5 конкатенація
  }

  document.addEventListener('visibilitychange', function() { // Звичайна функція
    if (document.visibilityState === 'hidden') {
      appSwitchTimer = setTimeout(function() { // Звичайна функція
        pushToDataLayer('app_switch_detected', {
          method: 'visibilitychange_timeout',
          page_location: window.location.href
        });
      }, timeoutDuration);
    } else {
      if (appSwitchTimer) {
        clearTimeout(appSwitchTimer);
        appSwitchTimer = null;
        console.log('Visibility restored, app switch cancelled.');
      }
    }
  });

  document.addEventListener('click', function(e) { 

    var target = e.target.closest('a');
    if (target && target.href) {
      // Замініть 'myapp://' та 'yourdomain.com/applink' на ваші реальні патерни deep link
      if (target.href.startsWith('myapp://') || target.href.indexOf('yourdomain.com/applink') !== -1) {
        pushToDataLayer('app_deep_link_click', {
          app_link_url: target.href,
          page_location: window.location.href
        });
      }
    }
  });

})();
